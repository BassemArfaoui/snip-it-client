<article class="rounded-3xl border border-[#f5f5f0] dark:border-white/10 bg-card-dark text-white p-5 sm:p-6 animate-slide-up shadow-soft">
  <!-- Header (avatar / name / meta / tag / menu) -->
  <div class="flex items-start justify-between gap-4">
    <div class="flex items-center gap-3 min-w-0">
      <div class="w-11 h-11 rounded-full bg-background-dark border border-white/10 flex items-center justify-center font-bold tracking-wide">
        {{ authorInitials() }}
      </div>
      <div class="min-w-0">
        <div class="font-bold text-base truncate">{{ post.author.fullName || post.author.username }}</div>
        <div class="flex items-center gap-2 text-sm text-text-muted truncate">
          <span class="truncate">{{ post.snippet.language }}</span>
          <span>•</span>
          <span class="truncate">{{ getRelativeTime(post.createdAt) }}</span>
        </div>
      </div>
    </div>

    <div class="flex items-center gap-2">
      <span class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-background-dark border border-white/10 text-xs font-semibold text-text-muted">
        <span class="material-symbols-outlined text-base">terminal</span>
        {{ post.snippet.language }}
      </span>

      <button
        type="button"
        class="inline-flex items-center justify-center w-10 h-10 rounded-full hover:bg-white/5 transition-colors"
        aria-label="More">
        <span class="material-symbols-outlined">more_horiz</span>
      </button>
    </div>
  </div>

  <!-- Body text -->
  <p class="mt-4 text-sm text-white/90 whitespace-pre-line leading-6">{{ post.description }}</p>

  <!-- Code block (dark inset like screenshot) -->
  <div class="mt-4 rounded-3xl border border-white/10 bg-background-dark p-4 sm:p-5">
    <div class="flex items-center justify-between mb-3">
      <div class="text-sm font-semibold text-white/90 truncate">{{ post.snippet.title || 'Snippet' }}</div>
      @if (post.githubLink) {
        <a
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/5 border border-white/10 text-xs font-semibold text-text-muted hover:text-primary transition-colors"
          [href]="post.githubLink"
          target="_blank"
          rel="noopener noreferrer">
          <span class="material-symbols-outlined text-base">link</span>
          GitHub
        </a>
      }
    </div>

    <pre class="overflow-auto max-h-[320px] text-sm leading-6 text-white/90"><code>{{ post.snippet.content }}</code></pre>
  </div>

  @if (post.interactions) {
    <div class="mt-5 flex flex-wrap items-center gap-2">
      <!-- Interact (left) + total count + hover menu -->
      <div class="relative">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full border border-white/10 px-3 py-2 text-sm font-semibold text-text-muted hover:bg-white/5 hover:text-white transition-colors"
          aria-label="Interact"
          (click)="toggleReactionsMenu($event)">
          @if (post.interactions!.myType) {
            <span class="text-lg leading-none">{{ reactionMeta(post.interactions!.myType!).emoji }}</span>
          } @else {
            <span class="material-symbols-outlined text-lg">add_reaction</span>
          }
          <span class="tabular-nums">{{ totalReactions() }}</span>
        </button>

        <div
          class="absolute left-0 bottom-12 z-10 rounded-full border border-white/10 bg-background-dark px-2 py-1 shadow-soft transition-all duration-150"
          [ngClass]="reactionsMenuOpen() ? 'opacity-100 translate-y-0 pointer-events-auto' : 'opacity-0 translate-y-1 pointer-events-none'">
          <div class="flex items-center gap-1">
            @for (type of reactionTypes; track type) {
              <button
                type="button"
                class="w-10 h-10 rounded-full inline-flex items-center justify-center transition-transform duration-150 hover:-translate-y-1 hover:scale-125"
                [ngClass]="{
                  'bg-white/5 ring-1 ring-primary/30': post.interactions!.myType === type,
                  'hover:bg-white/5': post.interactions!.myType !== type
                }"
                (click)="chooseReaction(type)"
                [attr.aria-label]="reactionMeta(type).label">
                <span class="text-xl leading-none">{{ reactionMeta(type).emoji }}</span>
              </button>
            }
          </div>
        </div>
      </div>

      <div class="ml-auto flex items-center gap-2">
        <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full border border-white/10 px-3 py-2 text-sm font-semibold text-text-muted hover:text-primary transition-colors"
          (click)="openCommentsModal()">
          <span class="material-symbols-outlined text-lg">comment</span>
          <span>{{ post.commentsCount || 0 }}</span>
        </button>

        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-white/10 hover:bg-white/5 transition-colors"
          (click)="copyCode()"
          aria-label="Copy code">
          <span class="material-symbols-outlined">content_copy</span>
        </button>

        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary text-black hover:bg-[#e6e205] transition-colors"
          (click)="openFullscreen()"
          aria-label="Open fullscreen">
          <span class="material-symbols-outlined">open_in_full</span>
        </button>
      </div>
    </div>
  }

  @if (toast()) {
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 rounded-full bg-black/80 text-white px-4 py-2 text-sm font-semibold animate-fade-in">
      {{ toast() }}
    </div>
  }

  @if (fullscreen()) {
    <div class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm p-4 sm:p-8" (click)="closeFullscreen()">
      <div class="h-full max-w-[1280px] mx-auto" (click)="$event.stopPropagation()">
        <div class="h-full rounded-3xl bg-white dark:bg-card-dark border border-[#f5f5f0] dark:border-white/10 overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-5 py-4 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="min-w-0">
              <div class="text-sm font-bold text-text-main dark:text-white truncate">{{ post.title }}</div>
              <div class="text-xs text-text-muted dark:text-gray-400">{{ post.snippet?.language }}</div>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-full border border-[#f5f5f0] dark:border-white/10 px-3 py-2 text-sm font-semibold text-text-main dark:text-white hover:bg-gray-50 dark:hover:bg-white/5 transition-colors"
                (click)="copyCode()">
                <span class="material-symbols-outlined">content_copy</span>
                Copy
              </button>
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-full bg-primary text-black px-3 py-2 text-sm font-semibold hover:bg-[#e6e205] transition-colors"
                (click)="closeFullscreen()">
                <span class="material-symbols-outlined">close</span>
                Close
              </button>
            </div>
          </div>
          <div class="flex-1 overflow-auto p-5 bg-[#f8f8f5] dark:bg-black/20">
            <pre class="text-sm leading-6 text-text-main dark:text-white"><code>{{ post.snippet?.content }}</code></pre>
          </div>
        </div>
      </div>
    </div>
  }

  @if (commentsModalOpen()) {
    <div class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm p-4 sm:p-8" (click)="closeCommentsModal()">
      <div class="h-full max-w-[900px] mx-auto" (click)="$event.stopPropagation()">
        <div class="h-full rounded-3xl bg-white dark:bg-card-dark border border-[#f5f5f0] dark:border-white/10 overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-5 py-4 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="min-w-0">
              <div class="text-sm font-bold text-text-main dark:text-white truncate">Comments</div>
              <div class="text-xs text-text-muted dark:text-gray-400 truncate">{{ post.title }}</div>
            </div>
            <button
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-primary text-black px-3 py-2 text-sm font-semibold hover:bg-[#e6e205] transition-colors"
              (click)="closeCommentsModal()">
              <span class="material-symbols-outlined">close</span>
              Close
            </button>
          </div>

          <div class="p-5 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="flex items-start gap-2">
              <textarea
                class="w-full rounded-2xl border border-[#f5f5f0] dark:border-white/10 bg-[#f5f5f0] dark:bg-black/10 px-4 py-3 text-sm text-text-main dark:text-white placeholder:text-text-muted/70 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/40"
                rows="2"
                placeholder="Write a comment…"
                [ngModel]="commentInput()"
                (ngModelChange)="commentInput.set($event)"></textarea>
              <button
                type="button"
                class="shrink-0 inline-flex items-center gap-2 rounded-full bg-primary text-black px-4 py-3 text-sm font-semibold hover:bg-[#e6e205] transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                [disabled]="submittingComment() || !commentInput().trim()"
                (click)="submitComment()">
                <span class="material-symbols-outlined">send</span>
              </button>
            </div>

            @if (commentError()) {
              <p class="mt-2 text-sm text-danger">{{ commentError() }}</p>
            }
          </div>

          <div class="flex-1 overflow-auto p-5 bg-[#f8f8f5] dark:bg-black/20">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-bold text-text-main dark:text-white">All comments</div>
              @if (commentsLoading()) {
                <div class="flex items-center gap-2 text-text-muted dark:text-gray-400">
                  <span class="material-symbols-outlined animate-spin">progress_activity</span>
                  <span class="text-sm">Loading…</span>
                </div>
              }
            </div>

            <div class="space-y-3">
              @for (c of comments(); track c.id) {
                <div class="rounded-2xl bg-white/70 dark:bg-white/5 p-4 border border-[#f5f5f0] dark:border-white/10">
                  <div class="flex items-center justify-between gap-3 mb-1">
                    <div class="text-sm font-semibold text-text-main dark:text-white">{{ c.user?.username }}</div>
                    <div class="text-xs text-text-muted dark:text-gray-400">{{ c.createdAt | date:'short' }}</div>
                  </div>
                  <p class="text-sm text-text-main dark:text-white/90 whitespace-pre-line">{{ c.content }}</p>
                </div>
              }

              @if (!commentsLoading() && comments().length === 0) {
                <p class="text-sm text-text-muted dark:text-gray-400">No comments yet.</p>
              }
            </div>
          </div>
        </div>
      </div>
    </div>
  }
</article>
