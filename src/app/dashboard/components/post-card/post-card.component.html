@if (!hidden()) {
<article class="rounded-3xl border border-gray-100 dark:border-white/10 bg-white dark:bg-card-dark text-text-main dark:text-white p-5 sm:p-6 animate-slide-up shadow-soft">
  <!-- Header (avatar / name / meta / tag / menu) -->
  <div class="flex items-start justify-between gap-4">
    <div class="flex items-center gap-3 min-w-0">
      <a
        [routerLink]="['/profile', post.author.id]"
        class="w-11 h-11 rounded-full bg-gray-100 dark:bg-background-dark border border-gray-200 dark:border-white/10 text-text-main dark:text-white flex items-center justify-center font-bold tracking-wide hover:border-primary/40"
        aria-label="Open author profile"
      >
        {{ authorInitials() }}
      </a>
      <div class="min-w-0">
        <a
          [routerLink]="['/profile', post.author.id]"
          class="font-bold text-base truncate hover:text-primary"
        >
          {{ post.author.fullName || post.author.username }}
        </a>
        <div class="flex items-center gap-2 text-sm text-text-muted dark:text-gray-400 truncate">
          <span class="truncate">{{ post.snippet.language }}</span>
          <span>•</span>
          <span class="truncate">{{ getRelativeTime(post.createdAt) }}</span>
        </div>
      </div>
    </div>

    @if (isOwnPost()) {
      <div class="relative flex items-center gap-2" (click)="$event.stopPropagation()">
        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full hover:bg-gray-100 dark:hover:bg-white/5 transition-colors"
          aria-label="More"
          (click)="toggleMoreMenu($event)"
        >
          <span class="material-symbols-outlined">more_horiz</span>
        </button>

        @if (moreMenuOpen()) {
          <div class="absolute right-0 top-11 w-40 rounded-2xl border border-gray-200 dark:border-white/10 bg-white dark:bg-card-dark shadow-soft overflow-hidden z-10">
            <button
              type="button"
              class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-main dark:text-white hover:bg-background-light dark:hover:bg-white/5 transition-colors"
              (click)="openEditModal($event)"
            >
              <span class="material-symbols-outlined text-xl">edit</span>
              <span>Edit</span>
            </button>
            <button
              type="button"
              class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-danger hover:bg-danger-light/40 dark:hover:bg-danger-dark/20 transition-colors"
              (click)="openDeleteConfirm($event)"
            >
              <span class="material-symbols-outlined text-xl">delete</span>
              <span>Delete</span>
            </button>
          </div>
        }
      </div>
    }
  </div>

  <!-- Body text -->
  <p class="mt-4 text-sm text-text-main dark:text-white/90 whitespace-pre-line leading-6">{{ post.description }}</p>

  <!-- Code block (dark inset like screenshot) -->
  <div class="mt-4 rounded-3xl border border-gray-100 dark:border-white/10 bg-[#f8f8f5] dark:bg-background-dark p-4 sm:p-5">
    <div class="flex items-center justify-between mb-3">
      <div class="text-sm font-semibold text-text-main dark:text-white/90 truncate">{{ post.snippet.title || 'Snippet' }}</div>
      @if (post.githubLink) {
        <a
          class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-white/70 dark:bg-white/5 border border-gray-200 dark:border-white/10 text-xs font-semibold text-text-muted dark:text-gray-300 hover:text-primary transition-colors"
          [href]="post.githubLink"
          target="_blank"
          rel="noopener noreferrer">
          <span class="material-symbols-outlined text-base">link</span>
          GitHub
        </a>
      }
    </div>

    <pre class="overflow-auto max-h-[320px] text-sm leading-6 text-text-main dark:text-white/90"><code>{{ post.snippet.content }}</code></pre>
  </div>

  @if (post.interactions) {
    <div class="mt-5 flex flex-wrap items-center gap-2">
      <!-- Reactions summary + Add interaction (left) -->
      <div class="flex items-center gap-2">
        <!-- Add interaction button + picker (left + distinct) -->
        <div class="relative">
          <button
            type="button"
            class="inline-flex items-center gap-2 rounded-full border border-primary/30 bg-primary/10 px-3 py-2 text-sm font-semibold text-text-main dark:text-white hover:bg-primary/15 transition-colors"
            aria-label="Interact"
            (click)="toggleReactionsMenu($event)">
            @if (post.interactions!.myType) {
              <span class="text-lg leading-none">{{ reactionMeta(post.interactions!.myType!).emoji }}</span>
            } @else {
              <span class="material-symbols-outlined text-lg">add_reaction</span>
            }
            <span class="tabular-nums">{{ totalReactions() }}</span>
          </button>

          <div
            class="absolute left-0 bottom-12 z-10 rounded-full border border-gray-200 dark:border-white/10 bg-white dark:bg-background-dark px-2 py-1 shadow-soft transition-all duration-150"
            [ngClass]="reactionsMenuOpen() ? 'opacity-100 translate-y-0 pointer-events-auto' : 'opacity-0 translate-y-1 pointer-events-none'">
            <div class="flex items-center gap-1">
              @for (type of reactionTypes; track type) {
                <button
                  type="button"
                  class="w-10 h-10 rounded-full inline-flex items-center justify-center transition-transform duration-150 hover:-translate-y-1 hover:scale-125"
                  [ngClass]="{
                    'bg-white/5 ring-1 ring-primary/30': post.interactions!.myType === type,
                    'hover:bg-white/5': post.interactions!.myType !== type
                  }"
                  (click)="chooseReaction(type)"
                  [attr.aria-label]="reactionMeta(type).label">
                  <span class="text-xl leading-none">{{ reactionMeta(type).emoji }}</span>
                </button>
              }
            </div>
          </div>
        </div>

        @for (type of visibleReactionTypes(); track type) {
          <div class="inline-flex items-center gap-1 rounded-full border border-gray-200 dark:border-white/10 bg-gray-50 dark:bg-white/5 px-2 py-1">
            <span class="text-sm leading-none">{{ reactionMeta(type).emoji }}</span>
            <span class="text-xs font-semibold tabular-nums text-text-muted dark:text-gray-300">{{ reactionCount(type) }}</span>
          </div>
        }
      </div>

      

      <div class="ml-auto flex items-center gap-2">
                <button
          type="button"
          class="inline-flex items-center gap-2 rounded-full border border-gray-200 dark:border-white/10 px-3 py-2 text-sm font-semibold text-text-muted dark:text-gray-300 hover:text-primary transition-colors"
          (click)="openCommentsModal()">
          <span class="material-symbols-outlined text-lg">comment</span>
          <span>{{ post.commentsCount || 0 }}</span>
        </button>

        <a
          [routerLink]="['/posts', post.id]"
          class="inline-flex items-center gap-2 rounded-full border border-gray-200 dark:border-white/10 px-3 py-2 text-sm font-semibold text-text-muted dark:text-gray-300 hover:text-primary transition-colors"
          aria-label="View post">
          <span class="material-symbols-outlined text-lg">open_in_new</span>
          <span class="hidden sm:inline">View</span>
        </a>
        <div class="relative" (click)="$event.stopPropagation()">
          
          <button
            type="button"
            class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 dark:border-white/10 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors"
            (click)="toggleSaveMenu($event)"
            aria-label="Save post">
            <span class="material-symbols-outlined">bookmark_add</span>
          </button>

          @if (saveMenuOpen()) {
            <div class="absolute right-0 mt-2 w-64 rounded-2xl border border-gray-200 dark:border-white/10 bg-white dark:bg-card-dark shadow-soft overflow-hidden">
              <button
                type="button"
                class="w-full flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-main dark:text-white hover:bg-background-light dark:hover:bg-white/5 transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                [disabled]="savingToCollection()"
                (click)="saveToDefaultCollection()">
                <span class="material-symbols-outlined text-xl">bookmark</span>
                <span>Save</span>
              </button>

              <div class="px-4 py-2 text-xs font-bold text-text-muted dark:text-gray-400 bg-background-light/40 dark:bg-white/5">
                Save to collection
              </div>

              @if (collectionsLoading()) {
                <div class="px-4 py-3 text-sm text-text-muted dark:text-gray-400 flex items-center gap-2">
                  <span class="material-symbols-outlined animate-spin">progress_activity</span>
                  <span>Loading…</span>
                </div>
              } @else {
                <div class="max-h-60 overflow-auto">
                  @for (col of collections(); track col.id) {
                    <button
                      type="button"
                      class="w-full text-left flex items-center gap-3 px-4 py-3 text-sm font-semibold text-text-main dark:text-white hover:bg-background-light dark:hover:bg-white/5 transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                      [disabled]="savingToCollection()"
                      (click)="savePostToCollection(col.id)">
                      <span class="material-symbols-outlined text-xl">folder</span>
                      <span class="truncate">{{ col.name }}</span>
                    </button>
                  }

                  @if (collections().length === 0) {
                    <div class="px-4 py-3 text-sm text-text-muted dark:text-gray-400">
                      No collections yet.
                    </div>
                  }
                </div>
              }
            </div>
          }
        </div>



        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full border border-gray-200 dark:border-white/10 hover:bg-gray-100 dark:hover:bg-white/5 transition-colors"
          (click)="copyCode()"
          aria-label="Copy code">
          <span class="material-symbols-outlined">content_copy</span>
        </button>

        <button
          type="button"
          class="inline-flex items-center justify-center w-10 h-10 rounded-full bg-primary text-black hover:bg-[#e6e205] transition-colors"
          (click)="openFullscreen()"
          aria-label="Open fullscreen">
          <span class="material-symbols-outlined">open_in_full</span>
        </button>
      </div>
    </div>
  }

  @if (toast()) {
    <div class="fixed bottom-6 left-1/2 -translate-x-1/2 rounded-full bg-black/80 text-white px-4 py-2 text-sm font-semibold animate-fade-in">
      {{ toast() }}
    </div>
  }

  @if (fullscreen()) {
    <div class="fixed inset-0 z-50 bg-black/70 backdrop-blur-sm p-4 sm:p-8" (click)="closeFullscreen()">
      <div class="h-full max-w-[1280px] mx-auto" (click)="$event.stopPropagation()">
        <div class="h-full rounded-3xl bg-white dark:bg-card-dark border border-[#f5f5f0] dark:border-white/10 overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-5 py-4 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="min-w-0">
              <div class="text-sm font-bold text-text-main dark:text-white truncate">{{ post.title }}</div>
              <div class="text-xs text-text-muted dark:text-gray-400">{{ post.snippet.language }}</div>
            </div>
            <div class="flex items-center gap-2">
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-full border border-[#f5f5f0] dark:border-white/10 px-3 py-2 text-sm font-semibold text-text-main dark:text-white hover:bg-gray-50 dark:hover:bg-white/5 transition-colors"
                (click)="copyCode()">
                <span class="material-symbols-outlined">content_copy</span>
                Copy
              </button>
              <button
                type="button"
                class="inline-flex items-center gap-2 rounded-full bg-primary text-black px-3 py-2 text-sm font-semibold hover:bg-[#e6e205] transition-colors"
                (click)="closeFullscreen()">
                <span class="material-symbols-outlined">close</span>
                Close
              </button>
            </div>
          </div>
          <div class="flex-1 overflow-auto p-5 bg-[#f8f8f5] dark:bg-black/20">
            <pre class="text-sm leading-6 text-text-main dark:text-white"><code>{{ post.snippet.content }}</code></pre>
          </div>
        </div>
      </div>
    </div>
  }

  @if (commentsModalOpen()) {
    <div class="fixed inset-0 z-50 bg-black/60 backdrop-blur-sm p-4 sm:p-8" (click)="closeCommentsModal()">
      <div class="h-full max-w-[900px] mx-auto" (click)="$event.stopPropagation()">
        <div class="h-full rounded-3xl bg-white dark:bg-card-dark border border-[#f5f5f0] dark:border-white/10 overflow-hidden flex flex-col">
          <div class="flex items-center justify-between px-5 py-4 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="min-w-0">
              <div class="text-sm font-bold text-text-main dark:text-white truncate">Comments</div>
              <div class="text-xs text-text-muted dark:text-gray-400 truncate">{{ post.title }}</div>
            </div>
            <button
              type="button"
              class="inline-flex items-center gap-2 rounded-full bg-primary text-black px-3 py-2 text-sm font-semibold hover:bg-[#e6e205] transition-colors"
              (click)="closeCommentsModal()">
              <span class="material-symbols-outlined">close</span>
              Close
            </button>
          </div>

          <div class="p-5 border-b border-[#f5f5f0] dark:border-white/10">
            <div class="flex items-start gap-2">
              <textarea
                class="w-full rounded-2xl border border-[#f5f5f0] dark:border-white/10 bg-[#f5f5f0] dark:bg-black/10 px-4 py-3 text-sm text-text-main dark:text-white placeholder:text-text-muted/70 dark:placeholder:text-gray-500 focus:outline-none focus:ring-2 focus:ring-primary/40"
                rows="2"
                placeholder="Write a comment…"
                [ngModel]="commentInput()"
                (ngModelChange)="commentInput.set($event)"></textarea>
              <button
                type="button"
                class="shrink-0 inline-flex items-center gap-2 rounded-full bg-primary text-black px-4 py-3 text-sm font-semibold hover:bg-[#e6e205] transition-colors disabled:opacity-60 disabled:cursor-not-allowed"
                [disabled]="submittingComment() || !commentInput().trim()"
                (click)="submitComment()">
                <span class="material-symbols-outlined">send</span>
              </button>
            </div>

            @if (commentError()) {
              <p class="mt-2 text-sm text-danger">{{ commentError() }}</p>
            }
          </div>

          <div #commentsScroll class="flex-1 overflow-auto p-5 bg-[#f8f8f5] dark:bg-black/20">
            <div class="flex items-center justify-between mb-3">
              <div class="text-sm font-bold text-text-main dark:text-white">All comments</div>
              @if (commentsLoading()) {
                <div class="flex items-center gap-2 text-text-muted dark:text-gray-400">
                  <span class="material-symbols-outlined animate-spin">progress_activity</span>
                  <span class="text-sm">Loading…</span>
                </div>
              }
            </div>

            <div class="space-y-3">
              @for (c of comments(); track c.id) {
                <div class="rounded-2xl bg-white/70 dark:bg-white/5 p-4 border border-[#f5f5f0] dark:border-white/10">
                  <div class="flex items-center justify-between gap-3 mb-1">
                    <a
                      [routerLink]="['/profile', c.user.id]"
                      class="text-sm font-semibold text-text-main dark:text-white hover:text-primary"
                    >
                      {{ c.user.username }}
                    </a>
                    <div class="text-xs text-text-muted dark:text-gray-400">{{ c.createdAt | date:'short' }}</div>
                  </div>
                  <p class="text-sm text-text-main dark:text-white/90 whitespace-pre-line">{{ c.content }}</p>
                </div>
              }

              @if (!commentsLoading() && comments().length === 0) {
                <p class="text-sm text-text-muted dark:text-gray-400">No comments yet.</p>
              }
            </div>

            @if (commentsLoadingMore()) {
              <div class="mt-4 flex items-center justify-center gap-2 text-text-muted dark:text-gray-400">
                <span class="material-symbols-outlined animate-spin">progress_activity</span>
                <span class="text-sm">Loading…</span>
              </div>
            }

            <div #commentsSentinel class="h-1"></div>
          </div>
        </div>
      </div>
    </div>
  }
</article>

@if (editModalOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center px-4" (click)="closeEditModal()">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-2xl bg-white dark:bg-card-dark rounded-2xl shadow-2xl p-6 border border-white/10" (click)="$event.stopPropagation()">
      <button
        class="absolute top-3 right-3 size-9 rounded-full bg-black/10 dark:bg-white/10 text-text-main dark:text-white flex items-center justify-center"
        type="button"
        (click)="closeEditModal($event)"
        [disabled]="editSaving()"
        aria-label="Close"
      >
        <span class="material-symbols-outlined text-lg">close</span>
      </button>

      <h3 class="text-xl font-bold text-text-main dark:text-white mb-1 pr-10">Edit post</h3>
      <p class="text-sm text-text-muted dark:text-gray-400 mb-4">Update your post details.</p>

      <div class="flex flex-col gap-4">
        <div class="flex flex-col gap-1">
          <label class="text-sm font-bold text-text-main dark:text-white">Title</label>
          <input
            [(ngModel)]="editTitle"
            type="text"
            class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm"
            placeholder="Post title"
          />
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-bold text-text-main dark:text-white">Description</label>
          <textarea
            [(ngModel)]="editDescription"
            rows="3"
            class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm"
            placeholder="What is this post about?"
          ></textarea>
        </div>

        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div class="flex flex-col gap-1">
            <label class="text-sm font-bold text-text-main dark:text-white">Snippet title</label>
            <input
              [(ngModel)]="editSnippetTitle"
              type="text"
              class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm"
              placeholder="(optional)"
            />
          </div>
          <div class="flex flex-col gap-1">
            <label class="text-sm font-bold text-text-main dark:text-white">Language</label>
            <input
              [(ngModel)]="editSnippetLanguage"
              type="text"
              class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm"
              placeholder="e.g. TypeScript"
            />
          </div>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-bold text-text-main dark:text-white">Snippet content</label>
          <textarea
            [(ngModel)]="editSnippetContent"
            rows="7"
            class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm font-mono"
            placeholder="Paste your code here"
          ></textarea>
        </div>

        <div class="flex flex-col gap-1">
          <label class="text-sm font-bold text-text-main dark:text-white">GitHub link</label>
          <input
            [(ngModel)]="editGithubLink"
            type="url"
            class="w-full rounded-lg border border-gray-200 dark:border-white/10 bg-white dark:bg-slate-900 px-3 py-2 text-sm"
            placeholder="https://github.com/... (optional)"
          />
          <p class="text-xs text-text-muted dark:text-gray-400">Must start with http/https.</p>
        </div>

        @if (editError()) {
          <div class="text-sm text-danger bg-danger-light/40 dark:bg-danger-dark/20 border border-danger/30 dark:border-danger/40 rounded-lg px-3 py-2">{{ editError() }}</div>
        }

        <div class="flex items-center justify-end gap-3 pt-2">
          <button
            type="button"
            class="px-4 py-2 rounded-full bg-gray-100 dark:bg-white/10 text-sm font-bold"
            (click)="closeEditModal($event)"
            [disabled]="editSaving()"
          >
            Cancel
          </button>
          <button
            type="button"
            class="px-5 py-2 rounded-full bg-primary text-black text-sm font-bold disabled:opacity-60"
            (click)="saveEdit($event)"
            [disabled]="editSaving()"
          >
            @if (editSaving()) { Saving... } @else { Save }
          </button>
        </div>
      </div>
    </div>
  </div>
}

@if (confirmDeleteOpen()) {
  <div class="fixed inset-0 z-50 flex items-center justify-center px-4" (click)="closeDeleteConfirm()">
    <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>
    <div class="relative w-full max-w-md bg-white dark:bg-card-dark rounded-2xl shadow-2xl p-6 border border-white/10" (click)="$event.stopPropagation()">
      <h3 class="text-lg font-bold text-text-main dark:text-white mb-2">Delete post?</h3>
      <p class="text-sm text-text-muted dark:text-gray-400 mb-5">This action can’t be undone.</p>

      <div class="flex items-center justify-end gap-3">
        <button
          type="button"
          class="px-4 py-2 rounded-full bg-gray-100 dark:bg-white/10 text-sm font-bold"
          (click)="closeDeleteConfirm($event)"
          [disabled]="deleting()"
        >
          Cancel
        </button>
        <button
          type="button"
          class="px-5 py-2 rounded-full bg-danger text-white text-sm font-bold disabled:opacity-60"
          (click)="confirmDelete($event)"
          [disabled]="deleting()"
        >
          @if (deleting()) { Deleting... } @else { Delete }
        </button>
      </div>
    </div>
  </div>
}
}
